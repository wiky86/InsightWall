<!DOCTYPE html>
<html lang="ko" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight Wall</title>
    <link rel="icon" type="image/png" href="wall.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 240 10% 3.9%;
            --card: 0 0% 100%;
            --card-foreground: 240 10% 3.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 240 10% 3.9%;
            --primary: 240 5.9% 10%;
            --primary-foreground: 0 0% 98%;
            --secondary: 240 4.8% 95.9%;
            --secondary-foreground: 240 5.9% 10%;
            --muted: 240 4.8% 95.9%;
            --muted-foreground: 240 3.8% 46.1%;
            --accent: 240 4.8% 95.9%;
            --accent-foreground: 240 5.9% 10%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 0 0% 98%;
            --border: 240 5.9% 90%;
            --input: 240 5.9% 90%;
            --ring: 240 5.9% 10%;
            --radius: 0.5rem;
        }

        .dark {
            --background: 240 10% 3.9%;
            --foreground: 0 0% 98%;
            --card: 240 10% 3.9%;
            --card-foreground: 0 0% 98%;
            --popover: 240 10% 3.9%;
            --popover-foreground: 0 0% 98%;
            --primary: 0 0% 98%;
            --primary-foreground: 240 5.9% 10%;
            --secondary: 240 3.7% 15.9%;
            --secondary-foreground: 0 0% 98%;
            --muted: 240 3.7% 15.9%;
            --muted-foreground: 240 5% 64.9%;
            --accent: 240 3.7% 15.9%;
            --accent-foreground: 0 0% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 0 0% 98%;
            --border: 240 3.7% 15.9%;
            --input: 240 3.7% 15.9%;
            --ring: 240 4.9% 83.9%;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: background-color 0.3s, color 0.3s;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-4px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(4px);
            }
        }

        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        .font-mono-nums {
            font-variant-numeric: tabular-nums;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { border: "hsl(var(--border))", input: "hsl(var(--input))", ring: "hsl(var(--ring))", background: "hsl(var(--background))", foreground: "hsl(var(--foreground))", primary: { DEFAULT: "hsl(var(--primary))", foreground: "hsl(var(--primary-foreground))" }, secondary: { DEFAULT: "hsl(var(--secondary))", foreground: "hsl(var(--secondary-foreground))" }, destructive: { DEFAULT: "hsl(var(--destructive))", foreground: "hsl(var(--destructive-foreground))" }, muted: { DEFAULT: "hsl(var(--muted))", foreground: "hsl(var(--muted-foreground))" }, accent: { DEFAULT: "hsl(var(--accent))", foreground: "hsl(var(--accent-foreground))" }, popover: { DEFAULT: "hsl(var(--popover))", foreground: "hsl(var(--popover-foreground))" }, card: { DEFAULT: "hsl(var(--card))", foreground: "hsl(var(--card-foreground))" } }, borderRadius: { lg: "var(--radius)", md: "calc(var(--radius) - 2px)", sm: "calc(var(--radius) - 4px)" } } }
        }
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark') } else { document.documentElement.classList.remove('dark') }
    </script>
</head>

<body class="min-h-screen antialiased relative overflow-hidden">

    <div id="access-gate"
        class="fixed inset-0 z-[100] bg-background flex items-center justify-center p-4 transition-opacity duration-500">
        <div
            class="w-full max-w-sm flex flex-col items-center space-y-6 text-center animate-in fade-in zoom-in duration-500">
            <div class="rounded-full bg-secondary p-4 mb-2"><i data-lucide="lock"
                    class="w-8 h-8 text-muted-foreground"></i></div>
            <div class="space-y-2">
                <h1 class="text-2xl font-bold tracking-tight">Insight Wall</h1>
                <p class="text-muted-foreground text-sm">부서 내부 인원만 접근 가능합니다.<br>비밀번호를 입력해주세요.</p>
            </div>
            <div class="w-full space-y-4">
                <div class="relative"><input type="password" id="gate-password"
                        class="flex h-11 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 text-center tracking-widest text-lg"
                        placeholder="••••" maxlength="20"></div>
                <p id="gate-error" class="text-sm text-red-500 font-medium hidden">비밀번호가 올바르지 않습니다.</p>
                <button id="gate-submit"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-11 px-8 w-full">입장하기</button>
            </div>
        </div>
    </div>

    <header
        class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="container mx-auto px-6 h-14 flex items-center justify-between">
            <span class="font-bold text-lg tracking-tight flex items-center gap-2 cursor-pointer"
                onclick="closeBoard()">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Insight Wall
            </span>
            <div class="flex items-center space-x-4">
                <div
                    class="hidden sm:flex items-center space-x-4 text-xs font-medium text-muted-foreground bg-secondary/50 px-3 py-1.5 rounded-full font-mono-nums">
                    <div class="flex items-center gap-1.5"><span class="opacity-70">TODAY</span><span id="visit-today"
                            class="text-foreground font-bold transition-all duration-500">0</span></div>
                    <div class="w-px h-3 bg-border"></div>
                    <div class="flex items-center gap-1.5"><span class="opacity-70">TOTAL</span><span id="visit-total"
                            class="text-primary font-bold transition-all duration-500">0</span></div>
                </div>
                <button id="theme-toggle"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground h-9 w-9"><i
                        data-lucide="sun"
                        class="h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0"></i><i
                        data-lucide="moon"
                        class="absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100"></i><span
                        class="sr-only">테마 전환</span></button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div id="main-dashboard" class="transition-opacity duration-300">
                            </span>
                            ${newBadge} </div>
                        ${tagsHTML}
                        <div class="flex justify-between items-center text-xs text-muted-foreground mt-auto">
                            <span class="flex items-center gap-1 opacity-80"><i data-lucide="user" class="w-3 h-3"></i> ${item.author}</span>
                            <span class="opacity-80">${item.date}</span>
                        </div>
                    </div>`;
                });

                if (group.items.length === 0) itemsHTML = `<div class="py-4 text-center text-sm text-muted-foreground">아직 공유된 내용이 없습니다.</div>`;

                wall.innerHTML += `
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm flex flex-col h-full">
                    <div class="flex flex-col space-y-1.5 p-6 pb-3">
                        <h3 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="${group.icon}" class="w-5 h-5 text-primary"></i>${group.posterTitle}</h3>
                        <p class="text-sm text-muted-foreground">${group.description}</p>
                    </div>
                    <div class="p-6 pt-0 flex-1">
                        <div class="flex flex-col divide-y divide-border">${itemsHTML}</div>
                    </div>
                    <div class="flex items-center p-6 pt-0 gap-3 mt-auto">
                        <button onclick="openBoard('${group.category}')" class="flex-1 inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2 transition-all active:scale-95">View All</button>
                        <button onclick="openModal('${group.category}')" class="flex-1 inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2 transition-all active:scale-95 gap-1"><i data-lucide="pen-line" class="w-3.5 h-3.5"></i> Write</button>
                    </div>
                </div>`;
            });
            lucide.createIcons();
        }

        // 통계 함수 (서버 호출)
        async function initVisitorCounter() {
            try {
                const response = await fetch(GOOGLE_SHEET_API_URL + "?action=recordVisit");
                if (!response.ok) throw new Error(`Stats HTTP error! status: ${response.status}`);
                const stats = await response.json();
                if (stats.result === 'success') {
                    animateCounter('visit-today', stats.today);
                    animateCounter('visit-total', stats.total);
                } else {
                    throw new Error(stats.error);
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
                animateCounter('visit-today', 0);
                animateCounter('visit-total', 0);
            }
        }
        function animateCounter(e, t) { const n = document.getElementById(e); let a = 0; const o = 1e3, r = performance.now(); function c(e) { const i = e - r, s = Math.min(i / o, 1), l = Math.floor(a + (t - a) * (1 - Math.pow(1 - s, 3))); n.textContent = l.toLocaleString(), s < 1 ? requestAnimationFrame(c) : n.textContent = t.toLocaleString() } requestAnimationFrame(c) }

        // --- [수정] 다크모드 리스너 추가 ---
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // --- 비밀번호 로직 (서버 인증) ---
        const gate = document.getElementById("access-gate"),
            gatePw = document.getElementById("gate-password"),
            gateErr = document.getElementById("gate-error"),
            gateSubmit = document.getElementById("gate-submit");

        if ("true" === sessionStorage.getItem("insight_wall_auth")) {
            gate.style.display = "none";
            document.body.classList.remove("overflow-hidden");
        }

        async function unlock() {
            const pass = gatePw.value;
            if (!pass) {
                gatePw.focus();
                return;
            }

            gateSubmit.disabled = true;
            gateSubmit.innerText = '확인 중...';
            gateErr.classList.add('hidden');

            try {
                const response = await fetch(GOOGLE_SHEET_API_URL + "?action=checkPassword&pass=" + encodeURIComponent(pass));
                if (!response.ok) throw new Error('서버 통신 실패');
                const data = await response.json();

                if (data.result === 'success') {
                    sessionStorage.setItem("insight_wall_auth", "true");
                    gate.style.opacity = "0";
                    setTimeout(() => {
                        gate.style.display = "none";
                        document.body.classList.remove("overflow-hidden");
                    }, 500);
                } else {
                    throw new Error('비밀번호 불일치');
                }
            } catch (error) {
                console.error('Unlock error:', error.message);
                gateErr.classList.remove("hidden");
                gatePw.classList.add("animate-shake", "border-red-500", "ring-red-500");
                setTimeout(() => gatePw.classList.remove("animate-shake", "border-red-500", "ring-red-500"), 500);
                gatePw.value = "";
                gatePw.focus();
                gateSubmit.disabled = false;
                gateSubmit.innerText = '입장하기';
            }
        }

        document.getElementById("gate-submit").addEventListener("click", unlock);
        gatePw.addEventListener("keypress", e => { "Enter" === e.key && unlock() });
        // --- 비밀번호 로직 끝 ---

        // --- (이하 나머지 코드는 동일) ---
        let currentCategory = ""; const mainDash = document.getElementById("main-dashboard"), boardView = document.getElementById("board-view"), boardTitle = document.getElementById("board-title"), boardDesc = document.getElementById("board-desc"), boardList = document.getElementById("board-list"), boardWriteBtn = document.getElementById("board-write-btn"), boardSearch = document.getElementById("board-search"), noResult = document.getElementById("no-result"); function openBoard(e) { currentCategory = e; const t = groupedMockData.find(t => t.category === e); t && (mainDash.classList.add("hidden"), boardView.classList.remove("hidden"), window.scrollTo(0, 0), boardTitle.innerHTML = `<i data-lucide="${t.icon}" class="w-8 h-8 text-primary"></i> ${t.posterTitle}`, boardDesc.textContent = t.description, boardWriteBtn.onclick = () => openModal(e), boardSearch.value = "", renderBoardList(t.items), lucide.createIcons()) } function closeBoard() { boardView.classList.add("hidden"), mainDash.classList.remove("hidden") } function renderBoardList(e) { boardList.innerHTML = "", 0 === e.length ? noResult.classList.remove("hidden") : (noResult.classList.add("hidden"), e.forEach(e => { const t = e.isNew ? '<span class="ml-2 inline-flex items-center rounded-full border border-rose-500/30 bg-rose-500/10 px-2 py-0.5 text-[10px] font-bold text-rose-600 dark:text-rose-400 shadow-[0_0_8px_rgba(244,63,94,0.2)]">NEW</span>' : "", n = e.tags && e.tags.length > 0 ? `<div class="flex flex-wrap gap-1 mt-1">${e.tags.map(e => `<span class="text-[10px] text-muted-foreground bg-muted px-1.5 py-0.5 rounded-sm">#${e}</span>`).join("")}</div>` : ""; boardList.innerHTML += `<tr class="hover:bg-muted/50 transition-colors cursor-pointer group" onclick="window.open('${e.link}', '_blank')"><td class="p-4 align-top"><div class="font-medium hover:underline underline-offset-4 group-hover:text-primary transition-colors">${e.title}${t}</div>${n}</td><td class="p-4 text-muted-foreground align-top whitespace-nowrap"><div class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> ${e.author || "익명"}</div></td><td class="p-4 text-right text-muted-foreground align-top whitespace-nowrap">${e.date}</td></tr>` })), lucide.createIcons() } boardSearch.addEventListener("input", e => { const t = e.target.value.toLowerCase(), n = groupedMockData.find(e => e.category === currentCategory); if (!n) return; const a = n.items.filter(e => (e.title && e.title.toLowerCase().includes(t)) || (e.author && e.author.toLowerCase().includes(t)) || (e.tags && e.tags.some(e => e.toLowerCase().includes(t)))); renderBoardList(a) }); const modal = document.getElementById("write-modal"), catSel = document.getElementById("modal-category"); function openModal(e) { catSel.value = e, modal.classList.remove("hidden"), modal.classList.add("flex") } function closeModal() { modal.classList.add("hidden"), modal.classList.remove("flex"), ["modal-title", "modal-tags", "modal-link", "modal-comment", "modal-author"].forEach(e => document.getElementById(e).value = "") } document.getElementById("modal-close").addEventListener("click", closeModal), modal.addEventListener("click", e => { e.target === modal && closeModal() });

        // '공유하기' 버튼 클릭 시 실제 데이터 전송
        document.getElementById('modal-submit').addEventListener('click', async () => {
            const submitBtn = document.getElementById('modal-submit');
            const originalBtnText = submitBtn.innerText;
            const category = document.getElementById('modal-category').value;
            const title = document.getElementById('modal-title').value;
            const tags = document.getElementById('modal-tags').value;
            const link = document.getElementById('modal-link').value;
            const comment = document.getElementById('modal-comment').value;
            const author = document.getElementById('modal-author').value;

            if (!title) { alert('제목을 입력해주세요.'); document.getElementById('modal-title').focus(); return; }

            submitBtn.disabled = true;
            submitBtn.innerText = '저장 중...';

            const payload = { category, title, tags, link, comment, author };

            try {
                await fetch(GOOGLE_SHEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                alert('성공적으로 공유되었습니다!');
                closeModal();
                setTimeout(() => {
                    fetchData();
                }, 1000);
            } catch (error) {
                console.error('Error submitting data:', error);
                alert('저장에 실패했습니다. 잠시 후 다시 시도해주세요.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
            }
        });

        // 페이지 로드 시 실행
        initVisitorCounter();
        fetchData(); 
    </script>
</body>

</html>